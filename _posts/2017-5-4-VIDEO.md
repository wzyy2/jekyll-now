---
layout: post
title: Video On Rockchip Linux Platform
category: [CN]
---

Rockchip在Linux上的Video框架采用的是Gstreamer, 关于这些基础信息，建议点击以下连接。
* http://opensource.rock-chips.com/wiki_Mpp  
* https://github.com/rockchip-linux/mpp  
* https://github.com/rockchip-linux/gstreamer-rockchip

Mpp是我们用的最底层的解码库， 他负责接受packet， 解析nal，slice这些。  
Gstreamer是提供给应用程序使用的接口，使用起来你只需要配置好gstreamer的pipeline，就什么不用关心了，不过要再上面加功能也比较麻烦，你不能从你的应用程序外面对图像做具体的操作，只能发送控制信息，如果要对图片做操作，比如旋转，截取之类的，都需要在pipeline上做。  
FFmpeg在Rockchip Linux上也有社区的实现，也是基于mpp， [“FFmpeg”](https://github.com/LongChair/FFmpeg )。


# test
rk-rootfs-build有测试用的脚本和命令

* [“解码”](https://github.com/rockchip-linux/rk-rootfs-build/blob/master/overlay-debug/usr/local/bin/test_dec-gst.sh  )
* [“编码”](https://github.com/rockchip-linux/rk-rootfs-build/blob/master/overlay-debug/usr/local/bin/test_enc.sh  )

不用urbin或者playbin的话，也可以用这样的手动指定的方式

    gst-launch-1.0  filesrc location=/1.mkv ! matroskademux  ! queue !  h264parse ! mppvideodec ! kmssink

显示fps

    fpsdisplaysink video-sink=kmssink signal-fps-measurements=true text-overlay=false --gst-debug=fpsdisplaysink:6
    
# display

一般显示有几种：
* CPU拷贝显示
* GPU拷贝显示
* DRM零拷贝显示

从性能上说，越后面越好，第一种大概720p，第二种1080p 30-40fps，第三种基本可以达到datasheet所标识的性能  
在gstreamer上的对应关系如下(括号里代表哪个display backend)

    | cpu | ximagesink(x11), xvimagesink(x11), glimagesink(x11), qtsink(x11) | 
    | gpu | waylandsink, glimagesink(wayland) , qtsink(wayland, eglfs) | 
    | drm | kmssink(eglfs), rkximagesink(x11), waylandsink(WIP) | 

### qt
gstreamer开发最方便的是qt了，用起来很方便。
如果你要在qt里面更改sink，那么修改QT_GSTREAMER_WIDGET_VIDEOSINK和QT_GSTREAMER_WINDOW_VIDEOSINK就好了

    export QT_GSTREAMER_WIDGET_VIDEOSINK=waylandsink
    export QT_GSTREAMER_WINDOW_VIDEOSINK=waylandsink

不过搭配不同display backend, 不同的qt multimeida api(qml/widget),都会表现不一样,建议参考rk的meta-rockchip-extra里的搭配  
一般eglfs指定kmssink,使用qml api, x11指定rkximagesink,使用qtvideowidget

