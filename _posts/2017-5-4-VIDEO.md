---
layout: post
title: Multimedia User Guide(Rockchip Linux)
category: [rockchip linux]
tag: [CN]
---

这里主要记录一些月经问题, 主要帮助通过gstreamer来在rockchip平台上做multimedia的开发, 如果你需要直接用使用底层的api, 比如通过mpp完成decode/encode, 通过v4l2操作rga做color convert, 如果不理解类似DRM, V4L2, DMABUF, OpenGLES的概念的话......恕没能力解释, 只能帮解BUG, 不能做教学......还是需要自行结合网络资料和参考已有代码.

# Gstreamer-1.0
Rockchip have provide two gstreamer plugin packages:
* [gstreamer-rockchip](https://github.com/rockchip-linux/gstreamer-rockchip)
* [gstreamer-rockchip-extra](https://github.com/rockchip-linux/gstreamer-rockchip-extra)

`(Note: gstreamer-rockchip source for debian is pushed to [my personal github](https://github.com/wzyy2/gstreamer-rockchip/tree/debian-20170811)` 

gstreamer-rockchip includes the following video decoders and encoders:

| Elements       | Type  |  Comments  | 
| :----:  | :----:  | :----:  | 
| mppvideodec    | Video Decoder | h264, h265, jpeg, vp8, vp9 |
| mpph264enc        |   Video Encoder    | h264   | 


gstreamer-rockchip-extra includes the following plugins:<br>
please refer to [gstreamer-rockchip-extra README](https://github.com/rockchip-linux/gstreamer-rockchip) on github for more infos.

| Elements       | Type  |  Comments  | 
| :----:  | :----:  | :----:  | 
| rkximagesink    | Video Render (sink) |  kmssink + ximagesink |
| kmssink        |   Video Render (sink)   | overlay display   | 
| rgaconvert       |    Video Converter   | video colorspace,format,size conversion  | 
| rkcamsrc        |    Device Sources  |  rockchip isp camera source  | 


# Pipeline Example

See: <br>
https://github.com/rockchip-linux/rk-rootfs-build/tree/master/overlay-debug/usr/local

Decode with uridecodebin/playbin:
```
gst-launch-1.0 uridecodebin uri=file:///usr/local/test.mp4  ! kmssink
```

Decode (JPEG):
```
gst-launch-1.0 -v videotestsrc  ! "video/x-raw,width=1920,height=1080"  ! queue ! jpegenc ! queue ! jpegparse ! queue ! mppvideodec ! kmssink 
```

Encode:
```
gst-launch-1.0 videotestsrc num-buffers=512 ! video/x-raw,format=NV12,width=1920,height= 1080,framerate=30/1 \
    ! queue ! mpph264enc ! queue ! h264parse ! mpegtsmux ! filesink location=/home/linaro/2k.ts
```

MIPI Camera:
```
gst-launch-1.0 rkcamsrc device=/dev/video0 io-mode=4 disable-3A=true ! videoconvert ! video/x-raw,format=NV12,width=640,height=480  ! kmssink
```

CIF Camera/USB Camera:
```
gst-launch-1.0 v4l2src device=/dev/video0 ! mppvideodec ! kmssink
```

RGA Convert:
```
gst-launch-1.0 -v videotestsrc ! "video/x-raw,format=BGRA, width=1920,height=1080,framerate=30/1" ! \
 rgaconvert hflip=false vflip=false rotation=90 input-crop=0x0x1920x1080 output-crop=0x0x640x360 \
 output-io-mode=dmabuf capture-io-mode=dmabuf ! \
 "video/x-raw,format=NV12, width=640,height=640x360,framerate=30/1" ! kmssink
```

# Device Driver

## VPU

rk的私有驱动, 一般不需要有接触, 使用mpp既可.

## RGA

Source:<br>
https://github.com/rockchip-linux/kernel/tree/release-4.4/drivers/media/platform/rockchip-rga

rga linux版本的驱动是根据v4l2 m2m的api写出来, 如果需要直接操作v4l2 device, 最好是参考驱动里的rga.c和v4l2 m2m的userspace demo, 
目前我们并没有提供任何的wrap lib.

## Camera

Source:<br>
https://github.com/rockchip-linux/kernel/tree/release-4.4/drivers/media/platform/rockchip-isp1

ISP驱动是rockchip最新上游标准开发出来的驱动, 如果需要直接操作v4l2 device, 最好是
先了解下V4L2 subdev和media controler的概念:
https://linuxtv.org/downloads/v4l-dvb-apis/uapi/v4l/dev-subdev.html

当然如果是复杂的sensor驱动, 使用rkcamsrc时, 也需要enable disable-autoconf, 自行控制这块的API.
(好像NVdia Tegra也是类似的)

ISP这里有一个不开源的3A算法库, 如果是raw sensor要效果调试, 需要联系rk.

# FAQ

#### I have use mppvideodec/mppvideoenc, however, it is slow.
检查下你是不是用了videoconvert, 如果使用了videoconvert, 如果用了, 那CPU会参与进去转颜色格式, 导致性能下降.
还有检查下你使用的sink, 想xvimagesink这种, 也是CPU直接拷贝的, 速度会很慢的. 可以的话尽量使用glimagesink, wayland(gpu)和kmssink, rkximagesink(drm).
其中drm的性能最好.另外要注意使用gpu的话, 在x11上有稍微的性能缺陷.

如果你一定要用autovideosink, 那么可以下面的补丁强制mppvideodec输出到rkximagesink上:


背景知识: 图像和视频这种的Buffer, 一般为了DMA coherent, 都是uncached, 这种情况下, 如果CPU要操作, 那耗时是很大的.

#### Playback with QT multiemdia is slow
同上, 需要指定sink, 具体的方法根据display backend不同而不同, 见:<br>
https://github.com/rockchip-linux/meta-rockchip-extra/tree/master/recipes-rk/autostart/autostart

#### How to build
Debian的使用[docker](https://github.com/rockchip-linux/docker-rockchip), yocto的话本身就是编译工具.
或者你自己想法办法, 这个不是一个应该问的问题.